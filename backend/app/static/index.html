<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Shorts - Video Upload</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover {
            border-color: #666;
            background-color: #f8f8f8;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background-color: #E8F5E9;
        }

        .upload-icon {
            font-size: 3rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #eee;
            border-radius: 2px;
            margin-top: 1rem;
            display: none;
        }

        .progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .upload-details {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .file-size {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .status {
            margin-top: 1rem;
            text-align: center;
            color: #666;
        }

        .video-container {
            margin-top: 2rem;
            width: 100%;
            max-width: 800px;
            display: none;
        }

        .video-player {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .video-title {
            margin: 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }

        .cut-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .time-inputs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .time-input {
            flex: 1;
        }

        .time-input label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .time-input input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .cut-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .cut-button:hover {
            background: #45a049;
        }

        .cut-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .subtitle-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 1rem;
        }

        .subtitle-button:hover {
            background: #1976D2;
        }

        .subtitle-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .subtitle-status {
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .cuts-container {
            margin-top: 2rem;
        }

        .cuts-title {
            color: #333;
            margin-bottom: 1rem;
        }

        .cut-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitles-data-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitles-data-title {
            color: #333;
            margin-bottom: 1rem;
        }

        .subtitles-data-controls {
            margin-bottom: 1rem;
        }

        .get-subtitles-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .get-subtitles-button:hover {
            background: #1976D2;
        }

        .get-subtitles-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .subtitles-data-content {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f8f8;
            border-radius: 4px;
            padding: 1rem;
        }

        .subtitles-data-display {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .analyze-subtitles-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-left: 0.5rem;
        }

        .analyze-subtitles-button:hover {
            background: #45a049;
        }

        .analyze-subtitles-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .ai-analysis-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .ai-analysis-title {
            color: #333;
            margin-bottom: 1rem;
        }

        .ai-analysis-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ai-analysis-result {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 4px;
        }

        .ai-analysis-result h3 {
            margin-top: 0;
            color: #333;
        }

        .time-range {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .apply-ai-cut-button {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .apply-ai-cut-button:hover {
            background: #7B1FA2;
        }

        .apply-ai-cut-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .ai-analysis-explanation {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 4px;
        }

        .ai-analysis-explanation h3 {
            margin-top: 0;
            color: #333;
        }

        .ai-explanation-display {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #fff;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* New styles for multiple sections */
        .ai-sections-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .ai-sections-title {
            color: #333;
            margin-bottom: 1rem;
        }

        .ai-sections-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ai-section-item {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .ai-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .ai-section-type {
            background: #9C27B0;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: capitalize;
        }

        .ai-section-time {
            color: #666;
            font-size: 0.9rem;
        }

        .ai-section-apply {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 0.5rem;
        }

        .ai-section-apply:hover {
            background: #45a049;
        }

        .ai-section-apply:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .ai-section-preview {
            margin-top: 1rem;
            display: none;
        }

        .ai-section-preview video {
            width: 100%;
            border-radius: 4px;
            background: #000;
        }

        .ai-section-preview-title {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .ai-section-status {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .ai-section-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .ai-section-download {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: none;
        }

        .ai-section-download:hover {
            background: #1976D2;
        }

        .ai-section-download:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .share-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .share-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
            color: white;
            font-size: 1.2rem;
        }

        .share-button:hover {
            transform: scale(1.1);
        }

        .share-twitter {
            background: #1DA1F2;
        }

        .share-facebook {
            background: #4267B2;
        }

        .share-instagram {
            background: #E1306C;
        }

        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .share-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .share-modal-title {
            margin-bottom: 1rem;
            color: #333;
        }

        .share-modal-input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .share-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .share-modal-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .share-modal-cancel {
            background: #f5f5f5;
            color: #333;
        }

        .share-modal-share {
            background: #4CAF50;
            color: white;
        }

        .share-modal-cancel:hover {
            background: #e0e0e0;
        }

        .share-modal-share:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Movie Shorts</h1>
        <div class="upload-area" id="dropZone">
            <div class="upload-icon">📁</div>
            <div class="upload-text">Drag and drop your video here</div>
            <div class="upload-hint">or click to select a file</div>
            <input type="file" id="fileInput" accept="video/*">
        </div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
        <div class="status"></div>
        <div class="video-container" id="videoContainer">
            <div class="video-title" id="videoTitle"></div>
            <video class="video-player" id="videoPlayer" controls>
                Your browser does not support the video tag.
            </video>
            <div class="cut-controls" id="cutControls">
                <div class="time-inputs">
                    <div class="time-input">
                        <label for="startTime">Start Time (seconds)</label>
                        <input type="number" id="startTime" min="0" step="0.1" value="0">
                    </div>
                    <div class="time-input">
                        <label for="endTime">End Time (seconds)</label>
                        <input type="number" id="endTime" min="0" step="0.1" value="0">
                    </div>
                </div>
                <button class="cut-button" id="cutButton">Cut Video</button>
                <button class="subtitle-button" id="subtitleButton">Get Subtitles</button>
                <div class="subtitle-status" id="subtitleStatus"></div>
            </div>
        </div>
        <div class="cuts-container" id="cutsContainer">
            <h2 class="cuts-title">Cut Videos</h2>
            <div id="cutsList"></div>
        </div>

        <!-- New section for displaying subtitles data -->
        <div class="subtitles-data-container" id="subtitlesDataContainer">
            <h2 class="subtitles-data-title">Subtitles Data</h2>
            <div class="subtitles-data-controls">
                <button class="get-subtitles-button" id="getSubtitlesButton">Get Subtitles Data</button>
                <button class="analyze-subtitles-button" id="analyzeSubtitlesButton" disabled>Analyze with AI</button>
            </div>
            <div class="subtitles-data-content">
                <pre id="subtitlesDataDisplay" class="subtitles-data-display"></pre>
            </div>
        </div>

        <!-- New section for displaying AI analysis results -->
        <div class="ai-analysis-container" id="aiAnalysisContainer">
            <h2 class="ai-analysis-title">AI Analysis Results</h2>
            <div class="ai-analysis-content">
                <div class="ai-analysis-result">
                    <h3>Recommended Clip</h3>
                    <div class="time-range">
                        <div class="time-input">
                            <label for="aiStartTime">Start Time (seconds)</label>
                            <input type="number" id="aiStartTime" min="0" step="0.1" value="0" readonly>
                        </div>
                        <div class="time-input">
                            <label for="aiEndTime">End Time (seconds)</label>
                            <input type="number" id="aiEndTime" min="0" step="0.1" value="0" readonly>
                        </div>
                    </div>
                    <button class="apply-ai-cut-button" id="applyAiCutButton" disabled>Apply AI Cut</button>
                </div>
                <div class="ai-analysis-explanation">
                    <h3>AI Explanation</h3>
                    <pre id="aiExplanationDisplay" class="ai-explanation-display"></pre>
                </div>
            </div>
        </div>

        <!-- New section for displaying multiple AI sections -->
        <div class="ai-sections-container" id="aiSectionsContainer">
            <h2 class="ai-sections-title">AI Recommended Sections</h2>
            <div class="ai-sections-list" id="aiSectionsList">
                <!-- Sections will be dynamically added here -->
            </div>
        </div>

        <!-- Add share modal -->
        <div class="share-modal" id="shareModal">
            <div class="share-modal-content">
                <h3 class="share-modal-title">Share Video</h3>
                <input type="text" class="share-modal-input" id="shareUrl" readonly>
                <div class="share-modal-buttons">
                    <button class="share-modal-button share-modal-cancel" onclick="closeShareModal()">Cancel</button>
                    <button class="share-modal-button share-modal-share" onclick="copyShareUrl()">Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.querySelector('.progress-bar');
        const progress = document.querySelector('.progress');
        const status = document.querySelector('.status');
        const videoContainer = document.getElementById('videoContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');
        const cutControls = document.getElementById('cutControls');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const cutButton = document.getElementById('cutButton');
        const cutsList = document.getElementById('cutsList');
        const subtitleButton = document.getElementById('subtitleButton');
        const subtitleStatus = document.getElementById('subtitleStatus');
        const getSubtitlesButton = document.getElementById('getSubtitlesButton');
        const subtitlesDataDisplay = document.getElementById('subtitlesDataDisplay');
        const subtitlesDataContainer = document.getElementById('subtitlesDataContainer');
        const analyzeSubtitlesButton = document.getElementById('analyzeSubtitlesButton');
        const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
        const aiStartTime = document.getElementById('aiStartTime');
        const aiEndTime = document.getElementById('aiEndTime');
        const applyAiCutButton = document.getElementById('applyAiCutButton');
        const aiExplanationDisplay = document.getElementById('aiExplanationDisplay');
        const aiSectionsContainer = document.getElementById('aiSectionsContainer');
        const aiSectionsList = document.getElementById('aiSectionsList');

        let currentVideoDuration = 0;
        let currentFilename = '';
        let currentSubtitlesData = null;

        // Handle click to upload
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Handle drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('video/')) {
                    uploadFile(file);
                } else {
                    status.textContent = 'Please upload a video file';
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uploadFile(file) {
            progressBar.style.display = 'block';
            status.textContent = 'Uploading...';
            videoContainer.style.display = 'none';
            cutsList.innerHTML = '';
            subtitleStatus.textContent = '';
            subtitleButton.disabled = true;

            // Show file size
            const fileSize = document.createElement('div');
            fileSize.className = 'file-size';
            fileSize.textContent = `File size: ${formatFileSize(file.size)}`;
            dropZone.appendChild(fileSize);

            const formData = new FormData();
            formData.append('video', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.querySelector('.progress').style.width = percentComplete + '%';
                    
                    // Update status with upload details
                    const uploaded = formatFileSize(e.loaded);
                    const total = formatFileSize(e.total);
                    status.textContent = `Uploading: ${uploaded} of ${total} (${Math.round(percentComplete)}%)`;
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    status.textContent = response.message;
                    
                    // Display the uploaded video
                    currentFilename = response.filename;
                    currentVideoDuration = response.duration;
                    videoTitle.textContent = response.filename;
                    videoPlayer.src = `/uploads/${response.filename}`;
                    videoContainer.style.display = 'block';
                    
                    // Set max value for end time input
                    endTimeInput.max = currentVideoDuration;
                    endTimeInput.value = currentVideoDuration;

                    // Check for subtitles
                    checkSubtitles(currentFilename);
                    
                    // Show subtitles data container
                    showSubtitlesDataContainer();
                } else {
                    const response = JSON.parse(xhr.responseText);
                    status.textContent = 'Error: ' + response.error;
                }
                // Remove file size display
                const fileSizeElement = document.querySelector('.file-size');
                if (fileSizeElement) {
                    fileSizeElement.remove();
                }
            };

            xhr.onerror = function() {
                status.textContent = 'Upload failed. Please try again.';
                // Remove file size display
                const fileSizeElement = document.querySelector('.file-size');
                if (fileSizeElement) {
                    fileSizeElement.remove();
                }
            };

            xhr.send(formData);
        }

        // Handle video cutting
        cutButton.addEventListener('click', async () => {
            const startTime = parseFloat(startTimeInput.value);
            const endTime = parseFloat(endTimeInput.value);

            if (startTime >= endTime || startTime < 0 || endTime > currentVideoDuration) {
                status.textContent = 'Invalid time range';
                return;
            }

            cutButton.disabled = true;
            status.textContent = 'Cutting video...';

            try {
                const response = await fetch('/cut', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: currentFilename,
                        startTime: startTime,
                        endTime: endTime
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    status.textContent = data.message;
                    addCutVideo(data.cut_filename);
                } else {
                    status.textContent = 'Error: ' + data.error;
                }
            } catch (error) {
                status.textContent = 'Error cutting video';
            } finally {
                cutButton.disabled = false;
            }
        });

        function addCutVideo(filename) {
            const cutItem = document.createElement('div');
            cutItem.className = 'cut-item';
            cutItem.innerHTML = `
                <div class="video-title">${filename}</div>
                <video class="video-player" controls>
                    <source src="/cuts/${filename}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
            cutsList.insertBefore(cutItem, cutsList.firstChild);
        }

        // Update end time max when start time changes
        startTimeInput.addEventListener('change', () => {
            const startTime = parseFloat(startTimeInput.value);
            if (startTime >= currentVideoDuration) {
                startTimeInput.value = 0;
            }
            endTimeInput.min = startTime;
        });

        // Update start time max when end time changes
        endTimeInput.addEventListener('change', () => {
            const endTime = parseFloat(endTimeInput.value);
            if (endTime > currentVideoDuration) {
                endTimeInput.value = currentVideoDuration;
            }
            startTimeInput.max = endTime;
        });

        // Handle subtitle extraction
        subtitleButton.addEventListener('click', async () => {
            try {
                subtitleButton.disabled = true;
                subtitleStatus.textContent = 'Processing... This may take a few minutes for AI transcription.';
                
                const response = await fetch(`/extract-subtitles/${currentFilename}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentFilename.split('.')[0]}.srt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    subtitleStatus.textContent = 'Subtitles downloaded successfully!';
                } else {
                    const data = await response.json();
                    subtitleStatus.textContent = 'Error: ' + data.error;
                }
            } catch (error) {
                subtitleStatus.textContent = 'Error extracting subtitles';
            } finally {
                subtitleButton.disabled = false;
            }
        });

        async function checkSubtitles(filename) {
            try {
                const response = await fetch(`/check-subtitles/${filename}`);
                const data = await response.json();
                
                if (data.has_subtitles) {
                    subtitleButton.disabled = false;
                    subtitleStatus.textContent = 'Subtitles available';
                } else {
                    subtitleButton.disabled = false;
                    subtitleStatus.textContent = 'No embedded subtitles found. Click to generate subtitles using AI.';
                }
            } catch (error) {
                subtitleButton.disabled = true;
                subtitleStatus.textContent = 'Error checking for subtitles';
            }
        }

        // Initially hide the subtitles data container
        subtitlesDataContainer.style.display = 'none';

        // Show subtitles data container when a video is uploaded
        function showSubtitlesDataContainer() {
            subtitlesDataContainer.style.display = 'block';
            getSubtitlesButton.disabled = false;
            analyzeSubtitlesButton.disabled = true;
            aiAnalysisContainer.style.display = 'none';
        }

        // Add event listener for the get subtitles button
        getSubtitlesButton.addEventListener('click', async () => {
            if (!currentFilename) {
                subtitlesDataDisplay.textContent = 'No video selected';
                return;
            }

            try {
                getSubtitlesButton.disabled = true;
                subtitlesDataDisplay.textContent = 'Loading subtitles data...';
                
                const response = await fetch(`/get-subtitles/${currentFilename}`);
                if (response.ok) {
                    const data = await response.json();
                    currentSubtitlesData = data;
                    subtitlesDataDisplay.textContent = JSON.stringify(data, null, 2);
                    analyzeSubtitlesButton.disabled = false;
                } else {
                    const errorData = await response.json();
                    subtitlesDataDisplay.textContent = `Error: ${errorData.error}`;
                }
            } catch (error) {
                subtitlesDataDisplay.textContent = `Error: ${error.message}`;
            } finally {
                getSubtitlesButton.disabled = false;
            }
        });

        // Update the analyze subtitles button event listener
        analyzeSubtitlesButton.addEventListener('click', async () => {
            if (!currentSubtitlesData || !currentSubtitlesData.subtitles) {
                aiExplanationDisplay.textContent = 'No subtitles data available';
                return;
            }

            try {
                analyzeSubtitlesButton.disabled = true;
                aiExplanationDisplay.textContent = 'Analyzing subtitles with AI...';
                aiAnalysisContainer.style.display = 'block';
                aiSectionsContainer.style.display = 'none';
                
                const response = await fetch('/api/analysis/analyze-subtitles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subtitles: currentSubtitlesData.subtitles
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Clear previous sections
                    aiSectionsList.innerHTML = '';
                    
                    // Display each section
                    data.sections.forEach((section, index) => {
                        const sectionElement = document.createElement('div');
                        sectionElement.className = 'ai-section-item';
                        sectionElement.innerHTML = `
                            <div class="ai-section-header">
                                <span class="ai-section-type">${section.type}</span>
                                <span class="ai-section-time">${section.start}s - ${section.end}s</span>
                            </div>
                            <button class="ai-section-apply" onclick="applySectionCut(this, ${section.start}, ${section.end})">
                                Apply This Cut
                            </button>
                            <div class="ai-section-status"></div>
                            <div class="ai-section-preview">
                                <div class="ai-section-preview-title">Preview:</div>
                                <video controls>
                                    <source src="/uploads/${currentFilename}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div class="ai-section-actions">
                                    <button class="ai-section-download" onclick="downloadCutVideo(this)">
                                        Download Cut Video
                                    </button>
                                    <div class="share-buttons">
                                        <button class="share-button share-twitter" onclick="shareVideo(this, 'twitter')" title="Share on Twitter">
                                            𝕏
                                        </button>
                                        <button class="share-button share-facebook" onclick="shareVideo(this, 'facebook')" title="Share on Facebook">
                                            f
                                        </button>
                                        <button class="share-button share-instagram" onclick="shareVideo(this, 'instagram')" title="Share on Instagram">
                                            📸
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        aiSectionsList.appendChild(sectionElement);
                    });
                    
                    // Show the sections container
                    aiSectionsContainer.style.display = 'block';
                    
                    // Display the explanation
                    aiExplanationDisplay.textContent = `AI has analyzed the video and found ${data.sections.length} engaging sections.`;
                } else {
                    const errorData = await response.json();
                    aiExplanationDisplay.textContent = `Error: ${errorData.error}`;
                }
            } catch (error) {
                aiExplanationDisplay.textContent = `Error: ${error.message}`;
            } finally {
                analyzeSubtitlesButton.disabled = false;
            }
        });

        // Function to apply a section cut
        async function applySectionCut(button, start, end) {
            const sectionItem = button.closest('.ai-section-item');
            const statusElement = sectionItem.querySelector('.ai-section-status');
            const previewElement = sectionItem.querySelector('.ai-section-preview');
            const videoElement = previewElement.querySelector('video');
            const downloadButton = previewElement.querySelector('.ai-section-download');
            const shareButtons = previewElement.querySelector('.share-buttons');
            
            // Show loading status
            statusElement.textContent = 'Processing cut...';
            button.disabled = true;
            downloadButton.style.display = 'none';
            shareButtons.style.display = 'none';
            
            try {
                const response = await fetch('/cut', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: currentFilename,
                        startTime: start,
                        endTime: end
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Update video source to the cut version
                    videoElement.src = `/cuts/${data.cut_filename}`;
                    previewElement.style.display = 'block';
                    statusElement.textContent = 'Cut completed successfully!';
                    // Store the cut filename for download and sharing
                    downloadButton.dataset.cutFilename = data.cut_filename;
                    downloadButton.style.display = 'block';
                    shareButtons.style.display = 'flex';
                    // Store the cut filename in all share buttons
                    shareButtons.querySelectorAll('.share-button').forEach(btn => {
                        btn.dataset.cutFilename = data.cutFilename;
                    });
                } else {
                    statusElement.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                statusElement.textContent = `Error: ${error.message}`;
            } finally {
                button.disabled = false;
            }
        }

        // Add the download function
        async function downloadCutVideo(button) {
            const cutFilename = button.dataset.cutFilename;
            if (!cutFilename) return;

            try {
                button.disabled = true;
                const response = await fetch(`/cuts/${cutFilename}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = cutFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading video:', error);
            } finally {
                button.disabled = false;
            }
        }

        // Add share functionality
        function shareVideo(button, platform) {
            const cutFilename = button.dataset.cutFilename;
            if (!cutFilename) return;

            const shareUrl = `${window.location.origin}/cuts/${cutFilename}`;
            const shareModal = document.getElementById('shareModal');
            const shareUrlInput = document.getElementById('shareUrl');
            
            shareUrlInput.value = shareUrl;
            shareModal.style.display = 'flex';

            // Store the platform for when user clicks share
            shareModal.dataset.platform = platform;
        }

        function closeShareModal() {
            const shareModal = document.getElementById('shareModal');
            shareModal.style.display = 'none';
        }

        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const shareButton = shareModal.querySelector('.share-modal-share');
            const originalText = shareButton.textContent;
            shareButton.textContent = 'Copied!';
            setTimeout(() => {
                shareButton.textContent = originalText;
            }, 2000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const shareModal = document.getElementById('shareModal');
            if (event.target === shareModal) {
                closeShareModal();
            }
        }
    </script>
</body>
</html> 